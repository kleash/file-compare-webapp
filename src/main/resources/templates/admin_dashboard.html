<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Admin Dashboard - File Comparison Tool</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css">
    <script src="https://unpkg.com/vue@3/dist/vue.global.prod.js"></script>
    <style>
        body { background-color: #f4f7f6; }
        .metric-card { transition: transform 0.2s ease-in-out; }
        .metric-card:hover { transform: translateY(-5px); box-shadow: 0 0.5rem 1rem rgba(0,0,0,.15)!important; }
        .table-responsive { max-height: 60vh; }
    </style>
</head>
<body>
<div id="adminApp" class="container-fluid py-4">
    <header class="d-flex justify-content-between align-items-center pb-3 mb-4 border-bottom">
        <h1 class="h3"><i class="fas fa-tachometer-alt me-2"></i>Admin Dashboard</h1>
        <a href="/" class="btn btn-sm btn-outline-secondary"><i class="fas fa-arrow-left me-1"></i> Back to Tool</a>
    </header>

    <!-- Usage Metrics -->
    <section id="usageMetrics" class="mb-5">
        <h2 class="h5 mb-3">Usage Overview</h2>
        <div v-if="loadingMetrics" class="text-center"><div class="spinner-border text-primary"></div></div>
        <div v-if="metricsError" class="alert alert-danger">{{ metricsError }}</div>
        <div v-if="!loadingMetrics && usageMetrics" class="row g-4">
            <div class="col-md-3" v-for="(value, key) in filteredMetrics" :key="key">
                <div class="card metric-card shadow-sm">
                    <div class="card-body text-center">
                        <h5 class="card-title display-6 fw-bold">{{ value }}</h5>
                        <p class="card-text text-muted">{{ formatMetricKey(key) }}</p>
                    </div>
                </div>
            </div>
        </div>
    </section>

    <!-- Comparison Logs Table -->
    <section id="comparisonLogs">
        <h2 class="h5 mb-3">Comparison History
            <button @click="fetchComparisonLogs" class="btn btn-sm btn-outline-primary ms-2" :disabled="loadingLogs">
                <i class="fas fa-sync-alt" :class="{'fa-spin': loadingLogs}"></i> Refresh
            </button>
        </h2>
        <div v-if="loadingLogs && comparisonLogs.length === 0" class="text-center"><div class="spinner-border text-secondary"></div></div>
        <div v-if="logsError" class="alert alert-danger">{{ logsError }}</div>
        <div v-if="!loadingLogs && comparisonLogs.length === 0 && !logsError" class="alert alert-info">No comparison logs found.</div>

        <div v-if="comparisonLogs.length > 0" class="table-responsive shadow-sm bg-white rounded">
            <table class="table table-striped table-hover table-sm align-middle">
                <thead class="table-light sticky-top">
                <tr>
                    <th>Timestamp</th>
                    <th>Session ID</th>
                    <th>S1 Files</th>
                    <th>S2 Files</th>
                    <th>Pairs Total</th>
                    <th>Matched Pairs</th>
                    <th>Mismatched Pairs</th>
                    <th>Time (ms)</th>
                    <th>User Agent (Snippet)</th>
                    <th>Actions</th>
                </tr>
                </thead>
                <tbody>
                <tr v-for="log in paginatedLogs" :key="log.id">
                    <td>{{ formatTimestamp(log.comparisonTimestamp) }}</td>
                    <td>{{ log.sessionId }}</td>
                    <td>{{ log.source1FileCount }}</td>
                    <td>{{ log.source2FileCount }}</td>
                    <td>{{ log.pairsConsidered }}</td>
                    <td class="text-success fw-bold">{{ log.fullyMatchedPairs }}</td>
                    <td class="text-danger fw-bold">{{ log.mismatchedPairs }}</td>
                    <td>{{ log.totalExecutionTimeMs }}</td>
                    <td>{{ truncate(log.userAgent, 40) }}</td>
                    <td>
                        <a v-if="log.reportsZipPath" :href="'/admin/download-session-zip/' + log.sessionId"
                           target="_blank" class="btn btn-sm btn-outline-success py-0 px-1" title="Download Reports ZIP">
                            <i class="fas fa-file-archive"></i>
                        </a>
                        <!-- <button class="btn btn-sm btn-outline-info py-0 px-1 ms-1" title="View Details (Not Implemented)"><i class="fas fa-eye"></i></button> -->
                    </td>
                </tr>
                </tbody>
            </table>
        </div>
        <!-- Pagination -->
        <nav v-if="totalPages > 1" aria-label="Page navigation" class="mt-3">
            <ul class="pagination justify-content-center">
                <li class="page-item" :class="{ disabled: currentPage === 1 }">
                    <a class="page-link" href="#" @click.prevent="changePage(currentPage - 1)">Previous</a>
                </li>
                <li v-for="page in pagesToShow" :key="page" class="page-item" :class="{ active: currentPage === page }">
                    <a v-if="page !== '...'" class="page-link" href="#" @click.prevent="changePage(page)">{{ page }}</a>
                    <span v-else class="page-link">...</span>
                </li>
                <li class="page-item" :class="{ disabled: currentPage === totalPages }">
                    <a class="page-link" href="#" @click.prevent="changePage(currentPage + 1)">Next</a>
                </li>
            </ul>
        </nav>
    </section>
</div>

<script>
    const { createApp, ref, onMounted, computed } = Vue;

    createApp({
        setup() {
            const usageMetrics = ref(null);
            const loadingMetrics = ref(true);
            const metricsError = ref(null);

            const comparisonLogs = ref([]);
            const loadingLogs = ref(true);
            const logsError = ref(null);

            const currentPage = ref(1);
            const itemsPerPage = ref(15); // Number of logs per page


            const fetchUsageMetrics = async () => {
                loadingMetrics.value = true;
                metricsError.value = null;
                try {
                    const response = await fetch('/admin/api/usage-metrics');
                    if (!response.ok) throw new Error(`HTTP error! status: ${response.status}`);
                    usageMetrics.value = await response.json();
                } catch (error) {
                    console.error("Error fetching usage metrics:", error);
                    metricsError.value = "Failed to load usage metrics. " + error.message;
                } finally {
                    loadingMetrics.value = false;
                }
            };

            const fetchComparisonLogs = async () => {
                loadingLogs.value = true;
                logsError.value = null;
                try {
                    const response = await fetch('/admin/api/comparison-logs');
                    if (!response.ok) throw new Error(`HTTP error! status: ${response.status}`);
                    comparisonLogs.value = await response.json();
                } catch (error) {
                    console.error("Error fetching comparison logs:", error);
                    logsError.value = "Failed to load comparison logs. " + error.message;
                } finally {
                    loadingLogs.value = false;
                }
            };

            onMounted(() => {
                fetchUsageMetrics();
                fetchComparisonLogs();
            });

            // Inside the Vue setup() function in admin_dashboard.html

            const formatTimestamp = (timestampString) => {
                if (!timestampString) return 'N/A';
                try {
                    const date = new Date(timestampString);
                    // Check if the date is valid after parsing
                    if (isNaN(date.getTime())) {
                        return 'Invalid Date';
                    }
                    return date.toLocaleString(); // Or use toDateString(), toTimeString(), etc.
                } catch (e) {
                    console.error("Error parsing timestamp:", timestampString, e);
                    return 'Invalid Date Format';
                }
            };

            const formatMetricKey = (key) => {
                return key.replace(/([A-Z])/g, ' $1').replace(/^./, str => str.toUpperCase());
            };

            const filteredMetrics = computed(() => {
                if (!usageMetrics.value) return {};
                // Example: filter out some internal metrics if needed, or reorder
                return usageMetrics.value;
            });

            const truncate = (text, length) => {
                if (!text) return '';
                return text.length > length ? text.substring(0, length) + '...' : text;
            };

            // Pagination logic
            const totalPages = computed(() => {
                return Math.ceil(comparisonLogs.value.length / itemsPerPage.value);
            });

            const paginatedLogs = computed(() => {
                const start = (currentPage.value - 1) * itemsPerPage.value;
                const end = start + itemsPerPage.value;
                return comparisonLogs.value.slice(start, end);
            });

            function changePage(page) {
                if (page >= 1 && page <= totalPages.value) {
                    currentPage.value = page;
                }
            }

            const pagesToShow = computed(() => {
                const pages = [];
                const maxPages = 5; // Max number of page links to show (e.g., 1 ... 5 6 7 ... 10)
                if (totalPages.value <= maxPages) {
                    for (let i = 1; i <= totalPages.value; i++) pages.push(i);
                } else {
                    pages.push(1);
                    let start = Math.max(2, currentPage.value - Math.floor((maxPages - 3) / 2));
                    let end = Math.min(totalPages.value - 1, currentPage.value + Math.floor((maxPages - 2) / 2));

                    if (currentPage.value <= Math.ceil(maxPages/2) -1 ) {
                        end = maxPages - 2;
                    }
                    if (currentPage.value >= totalPages.value - Math.floor(maxPages/2) +1) {
                        start = totalPages.value - maxPages + 3;
                    }

                    if (start > 2) pages.push('...');
                    for (let i = start; i <= end; i++) pages.push(i);
                    if (end < totalPages.value - 1) pages.push('...');
                    pages.push(totalPages.value);
                }
                return pages;
            });

            return {
                usageMetrics, loadingMetrics, metricsError,
                comparisonLogs, loadingLogs, logsError,
                fetchUsageMetrics, fetchComparisonLogs,
                formatTimestamp, formatMetricKey, filteredMetrics, truncate,
                currentPage, totalPages, paginatedLogs, changePage, pagesToShow
            };
        }
    }).mount('#adminApp');
</script>
<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>
</body>
</html>